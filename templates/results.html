{% extends "base.html" %}
{% block content %}

<head>
  <title>Waiting Room</title>
  <!-- Add jQuery before socket.io -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.2.0/socket.io.min.js"></script>
  <style>
    /* Your existing styles - unchanged */
    .progress {
      background-color: var(--background-light, #E0E0E0);
    }

    .progress-bar {
      background-color: var(--background-dark, #3D3D3D);
      transition: background-color 0.5s ease;
    }

    .progress-bar-complete {
      background-color: var(--bright-color, #7B1B38);
    }

    /* Existing styles */
    #updates {
      height: 50vh;
      overflow: auto;
    }

    #results {
      height: 50vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
    }

    body {
      padding-top: 70px;
    }

    /* Enhanced tooltip styling */
    .tooltip-header {
      cursor: help;
      position: relative;
      text-decoration: underline dotted;
    }

    /* Custom tooltip implementation */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      pointer-events: none;
      max-width: 250px;
      white-space: normal;
      line-height: 1.4;
    }

    [data-tooltip]:after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    [data-tooltip]:hover:before,
    [data-tooltip]:hover:after {
      opacity: 1;
      visibility: visible;
    }

    /* Style the question mark icons in headers - make them bigger and properly sized */
    .header-help-icon {
      color: var(--background-dark, #3D3D3D);
      font-size: 0.8em;
      margin-left: 6px;
      cursor: help;
      display: inline-block;
      width: 18px;
      height: 18px;
      line-height: 16px;
      text-align: center;
      border-radius: 50%;
      background-color: var(--background-light, #E0E0E0);
      border: 1px solid var(--background-dark, #3D3D3D);
      font-weight: bold;
      vertical-align: middle;
    }

    .header-help-icon:hover {
      background-color: var(--background-dark, #3D3D3D);
      color: var(--background-light, #E0E0E0);
    }

    /* Style for question marks in table cells */
    .cell-help-icon {
      color: var(--background-dark, #3D3D3D);
      font-size: 0.9em;
      margin-left: 4px;
      cursor: help;
      font-weight: bold;
    }

    /* Change warning color to 50% transparent bright color */
    .branch-warning {
      background-color: rgba(123, 27, 56, 0.5) !important;
      /* 50% transparent bright-color */
    }

    /* Add this to your existing styles */
    #log-container {
      max-height: 300px;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      font-family: monospace;
      font-size: 14px;
    }

    #log-container p {
      margin-bottom: 5px;
      line-height: 1.4;
    }

    /* Add column width control for More column */
    #results-table th:nth-child(8),
    #results-table td:nth-child(8) {
      width: 150px;
      min-width: 150px;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h2>Processing Job: {{ job_id }}</h2>

    <div class="card mb-4">
      <div class="card-header">
        Status: <span id="status-text">{{ status }}</span>
      </div>
      <div class="card-body">
        <div class="progress mb-3">
          <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>

        <!-- Add this information message with image -->
        <div id="processing-info" class="alert alert-info mt-3" style="display: none;">
          <div class="row">
            <div class="col-md-6">
              <h5><i class="fa fa-info-circle"></i> While your sequences are being analyzed:</h5>
              <p>PhyloNaP is placing your sequences into our reference trees to identify the most likely evolutionary
                relationships.</p>
              <ul>
                <li>Placements are shown as <span style="color:#7B1B38;font-weight:600;">red circles</span> on the
                  phylogenetic tree.</li>
                <li>Circle size reflects the relative likelihood of each placement.</li>
                <li>The clade that includes all the placements highlighted in <span
                    style="color:#7B1B38;font-weight:600;">red</span>.</li>
                <li>The consistency of annotations for the highlighted clade can be inspected in the Metadata summary.
                </li>
              </ul>

            </div>
            <div class="col-md-6">
              <img src="{{ url_for('static', filename='pictures/clade.png') }}" alt="Tree Placement"
                class="img-fluid my-2" style="max-width: 100%; max-height: 100%;">
            </div>
          </div>
        </div>

        <h5>Processing Log:</h5>
        <div id="log-container" class="p-2 bg-light">
          {% for line in log_content %}
          <p>{{ line }}</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="results-section" style="display:none">
      <div class="card">
        <div class="card-header">
          <h3>Results</h3>
        </div>
        <div class="card-body">
          <table id="results-table" class="table table-striped">
            <thead>
              <tr>
                <th>Query</th>
                <th>Tree ID</th>
                <th>Superfamily</th>
                <th>Family</th>
                <th
                  data-tooltip="Likelihood weight ratio (LWR): Statistical confidence of placement (range 0-1). For a query with multiple placements, all LWRs sum to 1.0. Higher values indicate more reliable placements.">
                  Likelihood weight ratio<span class="header-help-icon">?</span>
                </th>
                <th
                  data-tooltip="Branch length connecting query to the reference tree. Values > 1.0 suggest distant relationships and weak functional predictions.">
                  Branch Length<span class="header-help-icon">?</span>
                </th>
                <th>Description</th>
                <th>More</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Results will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Remove this div, it's now integrated into the card above
    <div id="processing-info" class="alert alert-info" style="display:none">
      <strong>Info:</strong> Your job is being processed. Please wait...
    </div>
    -->
  </div>
</body>
<script>
  $(document).ready(function () {
    const jobId = "{{ job_id }}";
    let currentStatus = "{{ status }}";
    let polling;

    // Make toggleAlternatives function global
    window.toggleAlternatives = function (query) {
      const alternativeRows = $(`tr[data-query="${query}"][data-alternative="true"]`);
      const toggleButton = $(`tr[data-query="${query}"][data-main="true"] .toggle-btn`);

      if (alternativeRows.is(':visible')) {
        alternativeRows.hide();
        const hiddenCount = alternativeRows.length;
        toggleButton.html(`Show ${hiddenCount} more placements`);
      } else {
        alternativeRows.show();
        toggleButton.html(`Hide alternatives`);
      }
    };

    // Set initial progress based on status
    let initialProgress = 0;
    if (currentStatus === "queued") initialProgress = 10;
    else if (currentStatus === "running") initialProgress = 50;
    else if (currentStatus === "finished") initialProgress = 100;
    else if (currentStatus === "error" || currentStatus === "failed") initialProgress = 0;

    if (initialProgress > 0) {
      updateProgress(initialProgress);
    }

    // Show results section if status is finished
    if (currentStatus === "finished") {
      $("#results-section").show();

      // Try to parse summary data if available
      try {
        const summaryData = JSON.parse('{{ summary|tojson|safe }}');
        if (summaryData) {
          populateResultsTable(summaryData);
        }
      } catch (e) {
        console.error("Error parsing summary data:", e);
      }
    }

    // Show error message if status indicates failure
    if (currentStatus === "error" || currentStatus === "failed") {
      $("#results-section").show();
      showErrorMessage();
    }

    // Show processing info if status is queued or running
    if (currentStatus === "queued" || currentStatus === "running") {
      $("#processing-info").show();
    }

    function updateProgress(progress) {
      // Update the width and text
      $("#progress-bar")
        .css("width", progress + "%")
        .attr("aria-valuenow", progress)
        .text(progress + "%");

      // Add color change when complete
      if (progress >= 100) {
        $("#progress-bar").addClass("progress-bar-complete");
      } else {
        $("#progress-bar").removeClass("progress-bar-complete");
      }
    }

    function updateStatus(statusData) {
      // Update progress bar
      updateProgress(statusData.progress);

      // Update status text
      $("#status-text").text(statusData.status);
      currentStatus = statusData.status;

      // Show info message while processing
      if (statusData.status === 'running' || statusData.status === 'queued') {
        $("#processing-info").fadeIn();
      } else {
        $("#processing-info").fadeOut();
      }

      // Update log lines
      if (statusData.log_lines && statusData.log_lines.length > 0) {
        const logHtml = statusData.log_lines.map(line => `<p>${line}</p>`).join('');
        $("#log-container").html(logHtml);
      }

      // Show results if finished
      if (statusData.status === 'finished') {
        // Stop polling
        clearInterval(polling);

        // Hide info message
        $("#processing-info").hide();

        // Show results section
        $("#results-section").show();

        // Populate results table if summary exists
        if (statusData.summary) {
          populateResultsTable(statusData.summary);
        }
      }

      // Show error message if job failed
      if (statusData.status === 'error' || statusData.status === 'failed') {
        // Stop polling
        clearInterval(polling);

        // Hide info message
        $("#processing-info").hide();

        // Show results section with error message
        $("#results-section").show();
        showErrorMessage();
      }
    }

    function showErrorMessage() {
      $("#results-table tbody").empty();
      $("#results-table tbody").append(`
        <tr>
          <td colspan="9" style="text-align: center; padding: 30px;">
            <div class="alert alert-danger" style="margin: 0;">
              <h5><i class="fa fa-exclamation-circle"></i> Processing Error</h5>
              <p><strong>An error occurred while processing your job.</strong></p>
              <p>Please report this issue along with your <strong>Job ID: ${jobId}</strong> to:</p>
              <p><a href="mailto:aleksandra.korenskaia@uni-tuebingen.de" class="btn btn-outline-primary">
                <i class="fa fa-envelope"></i> aleksandra.korenskaia@uni-tuebingen.de
              </a></p>
              <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                Including your Job ID will help us identify and resolve the issue quickly.
              </p>
            </div>
          </td>
        </tr>
      `);
    }

    function populateResultsTable(summary) {
      console.log("Populating table with:", summary);

      // Clear existing table
      $("#results-table tbody").empty();

      // Check if summary is an array (your actual structure)
      if (Array.isArray(summary)) {
        // Check if summary is empty (no matches found) - only show this for successful jobs
        if (summary.length === 0 && currentStatus === 'finished') {
          // Show no matches message (only for successful completion, not errors)
          $("#results-table tbody").append(`
            <tr>
              <td colspan="9" style="text-align: center; padding: 30px;">
                <div class="alert alert-warning" style="margin: 0;">
                  <h5><i class="fa fa-exclamation-triangle"></i> No reference tree found</h5>
                  <p><strong>Your protein sequences could not be matched to any reference trees in our database.</strong></p>
                  <p><strong>Possible reasons:</strong></p>
                  <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                    <li><strong>Eukaryotic proteins:</strong> The database excludes explicitly eukaryotic proteins (except for curated datasets)</li>
                    <li><strong>Poor representation:</strong> Protein families with fewer than 10 proteins are excluded (poorly represented in MiBiG and AntiSMASHdb)</li>
                    <li><strong>Sequence length:</strong> Very short (&lt;150 amino acids) or very long (&gt;1000 amino acids) sequences are filtered out</li>
                    <li><strong>Novel protein family:</strong> Your protein may belong to a family not yet included in our reference database</li>
                  </ul>
                  <p style="margin-top: 15px;"><strong>Suggestion:</strong> Try submitting sequences from well-characterized bacterial natural product biosynthetic pathways.</p>
                  <p style="margin-top: 10px;"><strong>Missing your protein?</strong> Feel free to contact us at 
                    <a href="mailto:aleksandra.korenskaia@uni-tuebingen.de">aleksandra.korenskaia@uni-tuebingen.de</a> 
                    to inform us about your enzyme of interest - we will try to include it with the next update!
                  </p>
                </div>
              </td>
            </tr>
          `);
          return;
        }

        // Group results by query name
        const groupedResults = {};
        summary.forEach(item => {
          const query = item.query;
          if (!groupedResults[query]) {
            groupedResults[query] = [];
          }
          groupedResults[query].push(item);
        });

        // For each query, sort by branch length and show only the best one initially
        Object.keys(groupedResults).forEach(query => {
          const results = groupedResults[query];

          // Sort by branch length (shortest first)
          results.sort((a, b) => {
            const lengthA = a.pendant_length || Infinity;
            const lengthB = b.pendant_length || Infinity;
            return lengthA - lengthB;
          });

          const bestResult = results[0];
          const hasMultiple = results.length > 1;

          // Create row for best result
          const row = createResultRow(bestResult, hasMultiple, query, results);
          $("#results-table tbody").append(row);
        });
      } else {
        // Handle any other format (fallback)
        $("#results-table tbody").append('<tr><td colspan="9">Invalid data format</td></tr>');
      }
    }

    function createResultRow(item, hasMultiple, query, allResults) {
      const branchLength = item.pendant_length || 0;
      const isDistant = branchLength > 1;

      // Branch length cell with transparent bright color warning
      const branchLengthCell = `
        <td class="${isDistant ? 'branch-warning' : ''}" 
            data-tooltip="Branch length connecting query to the reference tree${isDistant ? '. Warning: High branch length suggests distant relationship - conclusions on the protein functionality are weak' : ''}">
          ${branchLength ? branchLength.toFixed(6) : 'N/A'}${isDistant ? '<span class="cell-help-icon">?</span>' : ''}
        </td>
      `;

      // Show More button using non-active-button class from overall.css
      const showMoreCell = hasMultiple ?
        `<td><button class="btn btn-sm non-active-button toggle-btn" onclick="toggleAlternatives('${query}')">
          Show ${allResults.length - 1} more
        </button></td>` : '<td></td>';

      return `
        <tr data-query="${query}" data-main="true">
          <td>${query}</td>
          <td>${item.tree_id || "Unknown"}</td>
          <td>${item.superfamily || "Unknown"}</td>
          <td>${item.family || "Unknown"}</td>
          <td data-tooltip="Likelihood weight ratio (LWR): Statistical confidence of this placement. Higher values (closer to 1.0) indicate more reliable placements.">
            ${item.like_weight_ratio ? item.like_weight_ratio.toFixed(3) : 'N/A'}
          </td>
          ${branchLengthCell}
          <td>${item.description || 'No description'}</td>
          ${showMoreCell}
          <td>
            <a href="/jplace_render.html?jobId=${jobId}&query=${encodeURIComponent(query)}&treeId=${item.tree_id}" 
               class="btn btn-sm active-button">Tree</a>
          </td>
        </tr>
        ${hasMultiple ? createHiddenRows(allResults.slice(1), query) : ''}
      `;
    }

    function createHiddenRows(alternativeResults, query) {
      return alternativeResults.map(item => {
        const branchLength = item.pendant_length || 0;
        const isDistant = branchLength > 1;

        const branchLengthCell = `
          <td class="${isDistant ? 'branch-warning' : ''}" 
              data-tooltip="${isDistant ? '. Warning: High branch length suggests distant relationship.' : ''}">
            ${branchLength ? branchLength.toFixed(6) : 'N/A'}${isDistant ? '<span class="cell-help-icon">?</span>' : ''}
          </td>
        `;

        return `
          <tr data-query="${query}" data-alternative="true" style="display: none; background-color: #f8f9fa;">
            <td style="padding-left: 20px;">â†³ ${query}</td>
            <td>${item.tree_id || "Unknown"}</td>
            <td>${item.superfamily || "Unknown"}</td>
            <td>${item.family || "Unknown"}</td>
            <td data-tooltip="Likelihood weight ratio (LWR): Statistical confidence of this placement. Higher values (closer to 1.0) indicate more reliable placements.">
              ${item.like_weight_ratio ? item.like_weight_ratio.toFixed(3) : 'N/A'}
            </td>
            ${branchLengthCell}
            <td>${item.description || 'No description'}</td>
            <td></td>
            <td>
              <a href="/jplace_render.html?jobId=${jobId}&query=${encodeURIComponent(query)}&treeId=${item.tree_id}" 
                 class="btn btn-sm active-button">Tree</a>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Set up polling for updates - always start polling, but check status to stop it
    polling = setInterval(function () {
      // If already finished, stop polling
      if (currentStatus === 'finished') {
        clearInterval(polling);
        return;
      }

      $.ajax({
        url: "/job_status/" + jobId,
        type: "GET",
        success: function (data) {
          updateStatus(data);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching job status:", error);
        }
      });
    }, 2000);  // Poll every 2 seconds
  });
</script>

{% endblock %}