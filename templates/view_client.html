{% extends "base.html" %}

{% block title %}PhyloNaP - Client View{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/overall.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='js/phylotree.css') }}">
<style>
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color, #007bff);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .error-container {
        display: none;
        text-align: center;
        padding: 20px;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        color: #721c24;
        margin: 20px 0;
    }

    .tree-container {
        display: none;
    }

    .info-panel {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .info-panel h3 {
        margin-top: 0;
        color: var(--primary-color, #007bff);
    }

    .info-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
        align-items: center;
    }

    .info-label {
        font-weight: bold;
        color: #495057;
    }

    .back-button {
        margin-bottom: 20px;
    }

    .back-button a {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background-color: var(--secondary-color, #6c757d);
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s;
    }

    .back-button a:hover {
        background-color: var(--secondary-color-hover, #5a6268);
    }

    .layout {
        display: flex;
        width: 100%;
        height: 70vh;
    }

    .tree-panel {
        display: flex;
        flex-direction: column;
        flex: 4;
        margin: 0;
        padding: 0;
    }

    .tree-controls {
        flex-shrink: 0;
        height: 50px;
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .tree {
        height: calc(100% - 50px);
        width: 100% !important;
        flex-grow: 1;
        overflow: auto;
    }

    .details {
        flex: 1;
        padding: 20px;
        background-color: #f8f9fa;
        border-left: 1px solid #dee2e6;
        overflow-y: auto;
    }

    #tree_name {
        margin: 0;
        color: var(--primary-color, #007bff);
        font-size: 1.2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="back-button">
        <a href="{{ url_for('view') }}">
            <i class="fa fa-arrow-left"></i>
            Back to Upload
        </a>
    </div>

    <div class="loading-container" id="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading your phylogenetic data...</p>
    </div>

    <div class="error-container" id="error-container">
        <h3><i class="fa fa-exclamation-triangle"></i> Error</h3>
        <p id="error-message">An error occurred while loading your data.</p>
        <div class="alert alert-info mt-3">
            <strong><i class="fa fa-info-circle"></i> How to use this page:</strong>
            <ol>
                <li>Go to the <a href="{{ url_for('view') }}"><strong>Upload page</strong></a></li>
                <li>Select your tree file (.nwk, .newick format)</li>
                <li>Select your metadata file (.tsv, .csv format)</li>
                <li>Click "View Tree" button</li>
                <li>You'll be automatically redirected here with your data</li>
            </ol>
        </div>
        <p><a href="{{ url_for('view') }}" class="btn btn-primary"><i class="fa fa-upload"></i> Go to Upload page</a>
        </p>
    </div>

    <div class="tree-container" id="tree-container">
        <div class="info-panel">
            <h3><i class="fa fa-info-circle"></i> Dataset Information</h3>
            <div class="info-grid">
                <span class="info-label">Dataset Name:</span>
                <span id="dataset-name"></span>
                <span class="info-label">Superfamily:</span>
                <span id="superfamily-name"></span>
                <span class="info-label">Description:</span>
                <span id="description"></span>
                <span class="info-label">Number of Sequences:</span>
                <span id="sequence-count"></span>
                <span class="info-label">Metadata Columns:</span>
                <span id="metadata-columns"></span>
            </div>
        </div>

        <div class="layout">
            <div class="tree-panel">
                <div class="tree-controls">
                    <h3 id="tree_name"></h3>
                </div>
                <div class="tree">
                    <!-- This div structure matches phylotree_render.html -->
                    <div id="tree_data" nwk_data="" metadata="" metadata_list="" datasetDescr="" superfamily_name=""
                        dataset_name="" source="user" cite="">
                        <div id="tree">
                            <!-- Tree will be rendered here by tree_general.js -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="details">
                <div class="col">
                    <h4>Metadata</h4>
                    <div id="metadata-buttons-container">
                        <!-- Metadata buttons will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include the phylogenetic tree rendering scripts (same as phylotree_render.html) -->
<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="{{ url_for('static', filename='js/phylotree.js') }}"></script>
<script src="{{ url_for('static', filename='js/palette.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== VIEW_CLIENT.HTML JAVASCRIPT STARTED ===');
        alert('JavaScript is working on client page!');

        const sessionId = '{{ session_id }}';
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const treeContainer = document.getElementById('tree-container');
        const errorMessage = document.getElementById('error-message');

        console.log('Client viewer loaded, session ID:', sessionId);
        console.log('Checking sessionStorage...');
        console.log('Current URL:', window.location.href);
        console.log('SessionStorage length:', sessionStorage.length);

        // List all sessionStorage keys
        for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            console.log('SessionStorage key:', key, 'Value length:', sessionStorage.getItem(key)?.length || 0);
        }

        // Add a small delay to ensure sessionStorage is available
        setTimeout(function () {
            try {
                // Get data from sessionStorage
                const userData = sessionStorage.getItem('phylonap_user_data');
                console.log('SessionStorage data:', userData ? 'Found' : 'Not found');
                console.log('Raw userData length:', userData ? userData.length : 0);

                if (!userData) {
                    console.error('No sessionStorage data found');

                    // Try localStorage as fallback
                    const fallbackData = localStorage.getItem('phylonap_user_data');
                    if (fallbackData) {
                        console.log('Found data in localStorage, using as fallback');
                        sessionStorage.setItem('phylonap_user_data', fallbackData);
                        userData = fallbackData;
                    } else {
                        console.error('No data found in localStorage either');
                        throw new Error('No data found in browser storage. Please go to the upload page first, select your tree and metadata files, and click "View Tree" button.');
                    }
                }

                const data = JSON.parse(userData);
                console.log('Parsed data keys:', Object.keys(data));
                console.log('Session ID from data:', data.sessionId);
                console.log('Session ID from URL:', sessionId);

                // Verify session matches (optional security check)
                if (data.sessionId !== sessionId) {
                    console.warn('Session ID mismatch, but continuing with available data');
                }

                // Parse metadata
                const metadata = JSON.parse(data.metadataJson);

                if (!metadata || metadata.length === 0) {
                    throw new Error('No metadata found');
                }

                // Update info panel
                document.getElementById('dataset-name').textContent = data.datasetName || 'Unknown';
                document.getElementById('superfamily-name').textContent = data.superfamilyName || 'Unknown';
                document.getElementById('description').textContent = data.description || 'No description';
                document.getElementById('sequence-count').textContent = metadata.length.toString();
                document.getElementById('metadata-columns').textContent = data.metadataColumns.join(', ');

                // Update tree name
                document.getElementById('tree_name').textContent = data.superfamilyName + ' - ' + data.datasetName;

                // Populate tree_data attributes (same as phylotree_render.html)
                const treeDataDiv = document.getElementById('tree_data');
                treeDataDiv.setAttribute('nwk_data', data.treeContent);
                treeDataDiv.setAttribute('metadata', data.metadataJson);
                treeDataDiv.setAttribute('metadata_list', JSON.stringify(data.metadataColumns));
                treeDataDiv.setAttribute('datasetDescr', data.description);
                treeDataDiv.setAttribute('superfamily_name', data.superfamilyName);
                treeDataDiv.setAttribute('dataset_name', data.datasetName);
                treeDataDiv.setAttribute('source', 'user');
                treeDataDiv.setAttribute('cite', '');

                // Create metadata buttons
                createMetadataButtons(data.metadataColumns);

                // Hide loading, show tree container
                loadingContainer.style.display = 'none';
                treeContainer.style.display = 'block';

                // Initialize the tree (tree_general.js will read from tree_data attributes)
                console.log('Tree data prepared, waiting for tree_general.js to initialize...');
                console.log('Tree content length:', data.treeContent.length);
                console.log('Metadata length:', metadata.length);

                // Load tree_general.js dynamically to initialize the tree
                loadTreeScript();

            } catch (error) {
                console.error('Error loading client data:', error);
                showError(error.message);
            }
        }, 100); // End of setTimeout

        function createMetadataButtons(metadataColumns) {
            const container = document.getElementById('metadata-buttons-container');
            container.innerHTML = '';

            metadataColumns.forEach(column => {
                const button = document.createElement('button');
                button.id = column;
                button.className = 'btn m-1';
                button.style.backgroundColor = '#a61e37';
                button.style.color = 'white';
                button.textContent = column.replace('_', ' ');
                container.appendChild(button);
            });
        }

        function loadTreeScript() {
            // Load tree_general.js to initialize the phylogenetic tree
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='js/tree_general.js') }}";
            script.onload = function () {
                console.log('tree_general.js loaded successfully');
            };
            script.onerror = function () {
                console.error('Failed to load tree_general.js');
                showError('Failed to load tree visualization scripts');
            };
            document.head.appendChild(script);
        }

        function showError(message) {
            loadingContainer.style.display = 'none';
            treeContainer.style.display = 'none';
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
        }
    });
</script>
{% endblock %}