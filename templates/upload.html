<!-- templates/index.html -->
{% extends "base.html" %}
{% block content %}
<style>
    .form-container {
        margin-top: 20px;
        /* Add space between the header and the form */
        max-width: 600px;
        /* margin: 0 auto; */
        margin: 20px auto;
        /* Center the form and add top margin */
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 10px;
        background-color: #f9f9f9;
    }

    .form-container label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-container input,
    .form-container textarea,
    .form-container select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    /* Evolutionary Model Styling */
    .model-selection-group {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
    }

    .model-option {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding: 8px 0;
    }

    .model-option input[type="radio"] {
        width: auto;
        margin: 0 10px 0 0;
        transform: scale(1.2);
    }

    .model-option label {
        font-weight: normal;
        margin: 0 10px 0 0;
        flex-shrink: 0;
        min-width: 160px;
    }

    .model-option input[type="text"],
    .model-option input[type="file"] {
        flex: 1;
        margin: 0;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .model-option input[type="text"]:disabled,
    .model-option input[type="file"]:disabled {
        background-color: #f5f5f5;
        color: #999;
        border-color: #ddd;
    }

    .model-help-text {
        font-size: 0.85em;
        color: #666;
        margin-top: 8px;
        line-height: 1.4;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-secondary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .button-group {
        align-items: center;
    }

    .active-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }

    .active-button:hover {
        background-color: #0056b3;
    }

    /* .form-container input[type="submit"] {
        width: auto;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        border-radius: 5px;
    } */
    /* .form-container input[type="submit"]:hover {
        background-color: #0056b3;
    } */
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='js/overall.css') }}">

<div class="info-section"
    style="max-width: 600px; margin: 20px auto; padding: 15px; background-color: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 5px;">
    <h4 style="color: #1976d2; margin-bottom: 10px;">
        <i class="fa fa-info-circle"></i> Dataset Contribution Options
    </h4>
    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
            <h6 style="color: #1976d2; margin-bottom: 5px;">
                <i class="fa fa-eye"></i> View Tree
            </h6>
            <p style="font-size: 0.9em; margin: 0; color: #555;">
                Preview your dataset interactively before submission. Data is processed in your browser only - nothing
                is sent to our servers.
            </p>
        </div>
        <div style="flex: 1;">
            <h6 style="color: #1976d2; margin-bottom: 5px;">
                <i class="fa fa-cloud-upload"></i> Submit Dataset
            </h6>
            <p style="font-size: 0.9em; margin: 0; color: #555;">
                Submit your dataset for expert review and inclusion in the PhyloNaP database. Requires all fields to be
                completed.
            </p>
        </div>
    </div>
    <p style="font-size: 0.85em; color: #666; margin: 0;">
        <strong>Tip:</strong> Use "View Tree" to check your data formatting and visualization before submitting for
        review.
    </p>
</div>

<div class="form-container">
    <form action="/upload" method="post" enctype="multipart/form-data">
        <!-- Dataset Name -->
        <label for="dataset-name">Dataset Name: <span class="submission-required" style="color: #ff6b6b;">(required for
                submission)</span></label>
        <input type="text" id="dataset-name" name="dataset_name"
            placeholder="Enter a descriptive name for your dataset"><br>

        <!-- Dataset Description -->
        <label for="dataset-description">Dataset Description: <span class="submission-required"
                style="color: #ff6b6b;">(required for submission)</span></label>
        <textarea id="dataset-description" name="dataset_description"
            placeholder="Describe your dataset, methodology, and any relevant details"></textarea><br>

        <!-- Upload Tree (Newick format) -->
        <label for="tree-file">Upload Tree (Newick format): <span style="color: #2196f3;">*</span></label>
        <input type="file" id="tree-file" name="tree_file"
            accept=".nwk,.newick,.tree,.contree,.txt,.phy,.nhx,text/plain" required><br>
        <small style="color: #2196f3;">Required for both viewing and submission</small><br>

        <!-- Evolutionary Model -->
        <label for="evolutionary-model">Evolutionary Model (highly recommended):</label>
        <div class="model-selection-group">
            <div class="model-option">
                <input type="radio" id="model-text" name="model_input_type" value="text" checked>
                <label for="model-text">Enter model manually:</label>
                <input type="text" id="model-text-input" name="evolutionary_model_text"
                    placeholder="e.g., TVM+F+I+R4, WAG+I+G4, LG+F+I+R4">
            </div>
            <div class="model-option">
                <input type="radio" id="model-file" name="model_input_type" value="file">
                <label for="model-file">Upload IQ-TREE file:</label>
                <input type="file" id="model-file-input" name="iqtree_file" accept=".iqtree" disabled>
            </div>
            <div class="model-help-text">
                If you used IQ-TREE for phylogenetic reconstruction, you can upload the .iqtree file and we'll
                automatically extract the best-fit model from the "Best-fit model according to BIC" line.
            </div>
        </div>

        <!-- Upload Alignment -->
        <label for="alignment-file">Upload the alignment you used for the tree construction: <span
                class="submission-required" style="color: #ff6b6b;">(required for submission)</span></label>
        <input type="file" id="alignment-file" name="alignment_file" accept=".fasta,.fa" required><br>

        <!-- Upload Metadata Table -->
        <label for="metadata-file">Upload Metadata Table (must contain ID column with leaves names): <span
                style="color: #2196f3;">*</span></label>
        <input type="file" id="metadata-file" name="metadata_file" accept=".csv,.tsv" required><br>
        <small style="color: #2196f3;">Required for both viewing and submission</small><br>

        <!-- Upload HMM model (optional)
        <label for="hmm-file">Upload HMM model (optional):</label>
        <input type="file" id="hmm-file" name="hmm_file" accept=".hmm"><br> -->

        <!-- Enzyme's Superfamily -->
        <!-- <label for="superfamily">Enzyme's Superfamily (optional):</label>
        <select id="superfamily" name="superfamily">
            <option value="undefined">Undefined</option>
            {% for superfamily in superfamilies %}
            <option value="{{ superfamily.name }}">{{ superfamily.name }}</option>
            {% endfor %}
        </select><br> -->

        <!-- Data Type -->
        <label for="data-type">Alignment type</label>
        <select id="data-type" name="data_type" multiple>
            {% for data_type in data_types %}
            <option value="{{ data_type }}">{{ data_type }}</option>
            {% endfor %}
            <option value="full-gene">Full Gene</option>
            <option value="domains">Domain(s)</option>
        </select><br>

        <!-- Images -->
        <label for="image-files">Upload Images:</label>
        <input type="file" id="image-files" name="image_files" accept=".png,.jpg" multiple><br>
        <small>Image names should contain the ID from a phylogenetic tree leaf. You can have multiple images for one ID
            - enumerate them to order (for example, ADG27364.1_1.png, ADG27364.1_2.png, etc).</small><br>
        <small>If there are more than 100 images, please upload them as a zip archive.</small><br>


        <!-- Author(s) -->
        <label for="authors">Author(s):</label>
        <input type="text" id="authors" name="authors" required><br>

        <!-- Email -->
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br>

        <!-- Cite the Paper -->
        <label for="paper-link">Cite the Paper (add the doi):</label>
        <input type="url" id="paper-link" name="paper_link"><br>

        <!-- Submit Button -->
        <div class="button-group" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button type="button" id="view-tree-btn" class="btn-secondary">
                <i class="fa fa-eye"></i> View Tree
            </button>
            <input type="submit" value="Submit Dataset" class="active-button">
        </div>
    </form>
</div>

<script>
    // JavaScript to handle evolutionary model input switching
    const modelTextRadio = document.getElementById('model-text');
    const modelFileRadio = document.getElementById('model-file');
    const modelTextInput = document.getElementById('model-text-input');
    const modelFileInput = document.getElementById('model-file-input');

    modelTextRadio.addEventListener('change', function () {
        if (this.checked) {
            modelTextInput.disabled = false;
            modelFileInput.disabled = true;
            modelFileInput.value = '';
        }
    });

    modelFileRadio.addEventListener('change', function () {
        if (this.checked) {
            modelTextInput.disabled = true;
            modelTextInput.value = '';
            modelFileInput.disabled = false;
        }
    });

    // View Tree functionality
    document.getElementById('view-tree-btn').addEventListener('click', function () {
        processFilesForViewing();
    });

    async function processFilesForViewing() {
        const viewBtn = document.getElementById('view-tree-btn');

        // Show loading state
        viewBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
        viewBtn.disabled = true;

        try {
            // Get required files
            const treeFile = document.getElementById('tree-file').files[0];
            const metadataFile = document.getElementById('metadata-file').files[0];
            const alignmentFile = document.getElementById('alignment-file').files[0];

            // Basic validation
            if (!treeFile) {
                throw new Error('Please select a tree file to view');
            }

            if (!metadataFile) {
                throw new Error('Please select a metadata file to view');
            }

            // Check file sizes (10MB limit)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (treeFile.size > maxSize || metadataFile.size > maxSize) {
                throw new Error('File size must be less than 10MB');
            }

            // Read files
            const treeContent = await readFileAsText(treeFile);
            const metadataContent = await readFileAsText(metadataFile);
            const alignmentContent = alignmentFile ? await readFileAsText(alignmentFile) : null;

            // Get form data
            const datasetName = document.getElementById('dataset-name').value || 'Contributed Dataset';
            const datasetDescription = document.getElementById('dataset-description').value || 'Dataset contributed for submission';

            // Basic validation
            if (!treeContent.trim()) {
                throw new Error('Tree file is empty');
            }

            if (!metadataContent.trim()) {
                throw new Error('Metadata file is empty');
            }

            // Parse metadata
            const metadata = parseMetadata(metadataContent);
            if (!metadata || metadata.length === 0) {
                throw new Error('Could not parse metadata file');
            }

            // Basic tree validation
            if (!treeContent.includes('(') || !treeContent.includes(')')) {
                throw new Error('Tree file does not appear to be in Newick format');
            }

            // Store data in sessionStorage (client-side only)
            const sessionId = generateSessionId();
            const userData = {
                sessionId: sessionId,
                treeContent: treeContent,
                metadataJson: JSON.stringify(metadata),
                metadataColumns: Object.keys(metadata[0] || {}),
                datasetName: datasetName,
                superfamilyName: 'Contributed Dataset',
                description: datasetDescription,
                alignmentContent: alignmentContent,
                timestamp: new Date().toISOString()
            };

            sessionStorage.setItem('phylonap_user_data', JSON.stringify(userData));
            localStorage.setItem('phylonap_user_data', JSON.stringify(userData));

            console.log('Contribute data stored for viewing:', userData);

            // Redirect to viewer
            setTimeout(() => {
                window.location.href = `/view_client_working?session=${sessionId}`;
            }, 100);

        } catch (error) {
            alert('Error: ' + error.message);
            resetViewButton();
        }
    }

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsText(file);
        });
    }

    function parseMetadata(content) {
        try {
            const lines = content.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('Metadata must have at least a header and one data row');
            }

            // Try TSV first
            let separator = '\t';
            let headers = lines[0].split(separator);

            // If only one column, try comma separator
            if (headers.length === 1) {
                separator = ',';
                headers = lines[0].split(separator);
            }

            if (headers.length === 1) {
                throw new Error('Could not detect column separator (tried tab and comma)');
            }

            // Parse data rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index].trim();
                    });
                    data.push(row);
                }
            }

            return data;
        } catch (error) {
            throw new Error('Failed to parse metadata: ' + error.message);
        }
    }

    function generateSessionId() {
        return 'contribute_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function resetViewButton() {
        const viewBtn = document.getElementById('view-tree-btn');
        viewBtn.innerHTML = '<i class="fa fa-eye"></i> View Tree';
        viewBtn.disabled = false;
    }

    // Reset button on page load
    document.addEventListener('DOMContentLoaded', function () {
        resetViewButton();
    });
</script>

{% endblock %}